syntax = "proto3";

package resource;


enum OperationResult {
  OK = 0;
  FAILED = 1;
  CANCELLED = 2;
  TIMEOUT = 3;
  OVERLOAD = 4;
};

message KeySet { repeated string keys = 1; };

message ResourceKeys {
  KeySet required_keys = 1;
  repeated KeySet keys_or = 2;
};

message TaskHeader {
  bytes signerId = 1;
  bytes signature = 2;
  bytes sessionData = 3;
};

message SessionData {
  repeated KeySet permissions = 1;
  repeated bytes billingIds = 2;
  int64 end_timestamp_s = 3;
};

message ResourceRequestResult { OperationResult result = 1; };

service Resource {
  rpc ResourceSession(stream ResourceRequestUnion)
      returns (stream ResourceRequestResult);
};

message ResourceRequestUnion {
  oneof v {
    ResourceRequest resourceRequest = 1;
    BillAppend billAppend = 2;
    BillOverride billOverwrite = 3;
    ResourceFinish resourceFinish = 4;
  };
};

// Inits billing and returns auth paths - also confirms auth
message ResourceRequest {
  TaskHeader hdr = 1;
  repeated bytes billingIds = 2;
  map<string, double> billItems = 3;
};

message BillAppend { map<string, double> billItems = 1; };
message BillOverride { map<string, double> billItems = 1; };

// send ResourceFinish to confirm billing operation finish
message ResourceFinish { OperationResult result = 1; };
